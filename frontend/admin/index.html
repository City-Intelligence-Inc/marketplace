<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Research Podcasts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 0;
            margin-bottom: 20px;
        }

        nav .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        nav .logo {
            color: white;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
        }

        nav .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 30px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        nav .nav-links a:hover {
            opacity: 0.8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #333;
        }

        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #48bb78;
        }

        .button-danger {
            background: #f56565;
        }

        .paper-preview {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }

        .paper-preview h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .paper-preview p {
            color: #4a5568;
            margin: 5px 0;
        }

        .audio-player {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .transcript {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            white-space: pre-wrap;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
            white-space: pre-wrap;
        }

        .status-message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status-message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">üéôÔ∏è AI Research Podcasts</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/admin/">Admin</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Admin Dashboard</h1>
            <p>Manage your AI Research Podcasts</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Subscribers</h3>
                <div class="value" id="totalSubscribers">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Podcasts</h3>
                <div class="value" id="totalPodcasts">-</div>
            </div>
            <div class="stat-card">
                <h3>Last Sent</h3>
                <div class="value" style="font-size: 18px;" id="lastSent">-</div>
            </div>
        </div>

        <!-- Fetch Paper Card -->
        <div class="card">
            <h2>1. Add Paper</h2>

            <!-- Tab Navigation -->
            <div style="margin-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                <button onclick="switchTab('arxiv')" id="arxivTab" style="background: none; border: none; border-bottom: 3px solid #667eea; padding: 10px 20px; margin-bottom: -2px; color: #667eea; font-weight: 600;">From arXiv</button>
                <button onclick="switchTab('upload')" id="uploadTab" style="background: none; border: none; border-bottom: 3px solid transparent; padding: 10px 20px; margin-bottom: -2px; color: #666; font-weight: 600;">Upload PDF</button>
                <button onclick="switchTab('text')" id="textTab" style="background: none; border: none; border-bottom: 3px solid transparent; padding: 10px 20px; margin-bottom: -2px; color: #666; font-weight: 600;">From Text</button>
            </div>

            <!-- arXiv Tab -->
            <div id="arxivSection">
                <input type="url" id="arxivUrl" placeholder="https://arxiv.org/abs/2401.12345">
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="extractFullText" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span>Extract full PDF text (generates 7-10 min podcast instead of 5-7 min)</span>
                    </label>
                </div>
                <button onclick="fetchPaper()">Fetch Paper</button>
            </div>

            <!-- Upload Tab -->
            <div id="uploadSection" style="display: none;">
                <p style="color: #666; margin-bottom: 15px;">Upload a PDF and we'll automatically extract the text for your podcast.</p>
                <input type="url" id="paperUrl" placeholder="Paper URL (required - e.g., https://arxiv.org/abs/2401.12345)" required style="margin-bottom: 15px;">
                <input type="file" id="pdfFile" accept=".pdf" style="margin-bottom: 15px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                <button onclick="uploadPDF()">Upload PDF</button>
            </div>

            <!-- Text Tab -->
            <div id="textSection" style="display: none;">
                <p style="color: #666; margin-bottom: 15px;">Paste any text to generate a podcast transcript. Great for blog posts, articles, or custom content!</p>
                <input type="text" id="textTitle" placeholder="Podcast Title (e.g., 'AI Safety Principles')" style="margin-bottom: 15px;">
                <textarea id="customText" placeholder="Paste your text here... (minimum 100 characters)" style="width: 100%; min-height: 300px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px; font-family: inherit; margin-bottom: 15px; resize: vertical;"></textarea>
                <button onclick="generateFromText()">Generate Transcript from Text</button>
            </div>

            <div id="fetchSpinner" class="spinner"></div>
            <div id="fetchStatus" class="status-message"></div>

            <div id="paperPreview" class="paper-preview">
                <h3 id="paperTitle"></h3>
                <p><strong>Authors:</strong> <span id="paperAuthors"></span></p>
                <p><strong>Abstract:</strong> <span id="paperAbstract"></span></p>
                <p><strong>Paper ID:</strong> <span id="paperId"></span></p>
            </div>
        </div>

        <!-- Generate Transcript Card -->
        <div class="card">
            <h2>2. Generate Transcript</h2>
            <p style="color: #666; margin-bottom: 15px;">Paper ID: <span id="currentPaperId">-</span></p>

            <!-- Persona Selection -->
            <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 10px; border: 2px solid #e2e8f0;">
                <h3 style="margin-bottom: 15px; color: #333;">üé≠ Podcast Personas</h3>

                <!-- Host Persona -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Host Persona:
                    </label>
                    <select id="hostPersona" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px;">
                        <option value="curious_journalist">Curious Tech Journalist</option>
                    </select>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;" id="hostPersonaDesc">Loading...</p>
                </div>

                <!-- Expert Persona -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Expert Persona:
                    </label>
                    <select id="expertPersona" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px;">
                        <option value="academic_expert">Academic Researcher</option>
                    </select>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;" id="expertPersonaDesc">Loading...</p>
                </div>
            </div>

            <!-- Technical Level Selection -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                    üéì Technical Level:
                </label>
                <select id="technicalLevel" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px; margin-bottom: 10px;">
                    <option value="baby">üë∂ Explain to a Child (5 year old)</option>
                    <option value="highschool">üéí High School Level</option>
                    <option value="undergrad" selected>üéì Undergraduate Level</option>
                    <option value="graduate">üë®‚Äçüéì Graduate/Professional</option>
                    <option value="expert">üî¨ Expert Researcher</option>
                    <option value="nobel">üèÜ Nobel Laureate Level</option>
                </select>
                <p style="color: #666; font-size: 14px; margin-top: 5px;" id="technicalLevelDescription">Balanced technical accuracy with accessibility - good for most audiences</p>
            </div>

            <!-- Custom Topics -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                    üí° Custom Topics to Cover (Optional):
                </label>
                <textarea id="customTopics" placeholder="Enter specific areas you want the podcast to cover, e.g.:&#10;- Real-world applications in healthcare&#10;- Comparison with previous methods&#10;- Limitations and future work&#10;- Ethical implications&#10;&#10;Leave blank for automatic topic selection based on the paper." style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                <p style="color: #666; font-size: 13px; margin-top: 5px; font-style: italic;">
                    üí° Tip: The AI will naturally weave these topics into the conversation while maintaining podcast quality
                </p>
            </div>

            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="useFullTextForTranscript" style="margin-right: 10px; width: 20px; height: 20px;">
                    <span>Use full PDF text (7-10 min script instead of 5-7 min from abstract only)</span>
                </label>
            </div>
            <button onclick="generateTranscript()" id="generateTranscriptBtn" disabled>Generate Transcript</button>

            <div id="transcriptSpinner" class="spinner"></div>
            <div id="transcriptStatus" class="status-message"></div>

            <div id="transcriptSection" style="display: none;">
                <h3 style="margin-top: 20px;">üìù Generated Transcript:</h3>
                <div id="transcript" class="transcript" style="display: block;"></div>
                <button onclick="editTranscript()" style="margin-top: 10px; background: #ed8936;">Edit Transcript</button>
            </div>
        </div>

        <!-- Convert to Audio Card -->
        <div class="card">
            <h2>3. Convert to Audio</h2>
            <p style="color: #666; margin-bottom: 15px;">Paper ID: <span id="currentPaperId2">-</span></p>

            <!-- Custom Voice Selection -->
            <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 10px; border: 2px solid #e2e8f0;">
                <h3 style="margin-bottom: 15px; color: #333;">üé§ Custom Voice Selection</h3>

                <!-- Host Voice -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Host Voice:
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="hostVoice" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px;">
                            <option value="rachel">Rachel - Warm, curious, engaging</option>
                        </select>
                        <button onclick="previewVoice('host')" style="padding: 12px 20px; font-size: 16px; background: #48bb78; white-space: nowrap;">
                            ‚ñ∂Ô∏è Preview
                        </button>
                    </div>
                </div>

                <!-- Expert Voice -->
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Expert Voice:
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="expertVoice" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px;">
                            <option value="adam">Adam - Knowledgeable, calm, clear</option>
                        </select>
                        <button onclick="previewVoice('expert')" style="padding: 12px 20px; font-size: 16px; background: #48bb78; white-space: nowrap;">
                            ‚ñ∂Ô∏è Preview
                        </button>
                    </div>
                </div>

                <p style="color: #666; font-size: 13px; margin-top: 10px; font-style: italic;">
                    üí° Tip: Try different combinations! Popular choices: Rachel (host) + Adam (expert), Bella (host) + Arnold (expert)
                </p>
            </div>

            <button onclick="convertToAudio()" id="convertBtn" disabled>Convert Transcript to Podcast</button>

            <div id="convertSpinner" class="spinner"></div>
            <div id="convertStatus" class="status-message"></div>

            <div id="podcastPreview" class="audio-player">
                <h3>üéß Podcast Generated!</h3>
                <audio controls id="audioPlayer" style="width: 100%; max-width: 600px; margin: 15px 0;">
                    <source id="audioSource" type="audio/mpeg">
                </audio>
                <p>Podcast ID: <span id="podcastId"></span></p>
            </div>
        </div>

        <!-- Send Email Card -->
        <div class="card">
            <h2>4. Send to Subscribers</h2>
            <p style="color: #666; margin-bottom: 15px;">Current Podcast: <span id="currentPodcastId">-</span></p>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button onclick="sendTestEmail()" id="sendTestBtn" style="background: #ed8936;" disabled>Send Test Email (to yourself)</button>
                <button onclick="sendToSelectedUsers()" id="sendToSelectedBtn" style="background: #48bb78;" disabled>Send to Selected Users</button>
                <button onclick="sendPodcast()" id="sendBtn" class="button-secondary" disabled>Send to ALL Subscribers</button>
            </div>

            <div id="sendSpinner" class="spinner"></div>
            <div id="sendStatus" class="status-message"></div>
        </div>

        <!-- History Card -->
        <div class="card">
            <h2>Podcast History</h2>
            <button onclick="loadHistory()" style="margin-bottom: 20px;">Refresh History</button>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Date Sent</th>
                        <th>Paper Title</th>
                        <th>Recipients</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- User Management Card -->
        <div class="card">
            <h2>üë• User Management</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <p style="color: #666;">Total Users: <strong id="totalUsers">-</strong></p>
                <button onclick="loadUsers()" style="background: #48bb78;">Refresh Users</button>
            </div>

            <!-- Quick Add User Section -->
            <div style="margin-bottom: 25px; padding: 20px; background: #f0fff4; border: 2px solid #48bb78; border-radius: 10px;">
                <h3 style="margin-bottom: 15px; color: #2f855a;">‚ûï Quick Add User</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                    <input type="email" id="quickAddEmail" placeholder="Email address" style="margin-bottom: 0;">
                    <input type="text" id="quickAddName" placeholder="Name (optional)" style="margin-bottom: 0;">
                    <button onclick="quickAddUser()" id="quickAddBtn" style="background: #48bb78; white-space: nowrap;">Add User</button>
                </div>
                <div id="quickAddStatus" class="status-message" style="margin-top: 10px;"></div>
            </div>

            <!-- Bulk Import Section -->
            <div style="margin-bottom: 25px; padding: 20px; background: #fef5e7; border: 2px solid #f39c12; border-radius: 10px;">
                <h3 style="margin-bottom: 15px; color: #d68910;">üìÇ Bulk Import from CSV</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Upload a CSV file with email addresses (one per line, or comma-separated)</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="csvFileInput" accept=".csv,.txt" style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 5px; background: white;">
                    <button onclick="bulkImportCSV()" id="bulkImportBtn" style="background: #f39c12; white-space: nowrap;">Import CSV</button>
                </div>
                <div id="bulkImportStatus" class="status-message" style="margin-top: 10px;"></div>
                <div id="bulkImportSpinner" class="spinner"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <input type="text" id="userSearch" placeholder="Search by email or name..." onkeyup="filterUsers()" style="margin-bottom: 0;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="selectAllUsers" onclick="toggleSelectAll()" style="margin-right: 10px; width: 20px; height: 20px;">
                    <span><strong>Select All</strong></span>
                </label>
            </div>

            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 5px;">
                <table id="usersTable" style="margin-bottom: 0;">
                    <thead style="position: sticky; top: 0; background: white;">
                        <tr>
                            <th style="width: 40px;">Select</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Signup Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                        <tr><td colspan="5" style="text-align: center;">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 5px;">
                <p style="margin-bottom: 10px;"><strong>Selected:</strong> <span id="selectedCount">0</span> users</p>
                <button onclick="showEmailComposer()" id="composeEmailBtn" style="background: #ed8936;" disabled>‚úâÔ∏è Compose Email to Selected Users</button>
            </div>
        </div>

        <!-- Manual Email Card -->
        <div class="card" id="emailComposerCard" style="display: none;">
            <h2>‚úâÔ∏è Compose Email</h2>
            <p style="color: #666; margin-bottom: 20px;">Sending to <strong id="recipientCount">0</strong> selected users</p>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">From Name:</label>
                <input type="text" id="emailFromName" placeholder="AI Research Podcasts" value="AI Research Podcasts">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Subject:</label>
                <input type="text" id="emailSubject" placeholder="Important Update about Your AI Research Podcasts">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Message:</label>
                <textarea id="emailMessage" placeholder="Write your message here... (line breaks will be preserved)" style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="sendManualEmail()" id="sendEmailBtn" style="background: #48bb78;">Send Email</button>
                <button onclick="hideEmailComposer()" style="background: #718096;">Cancel</button>
            </div>

            <div id="emailSpinner" class="spinner"></div>
            <div id="emailStatus" class="status-message"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://four0k-arr-saas.onrender.com';
        const ADMIN_PASSWORD = 'podcast2025'; // Change this to your desired password
        let currentPaperId = null;
        let currentPodcastId = null;
        let currentTranscript = null;
        let hasFullText = false;

        // Check password on page load
        window.addEventListener('load', () => {
            const savedPassword = sessionStorage.getItem('adminPassword');
            if (savedPassword !== ADMIN_PASSWORD) {
                const password = prompt('Enter admin password:');
                if (password !== ADMIN_PASSWORD) {
                    alert('Incorrect password');
                    window.location.href = '/';
                    return;
                }
                sessionStorage.setItem('adminPassword', password);
            }

            loadStats();
            loadHistory();
            loadIndividualVoices();
            loadPersonas();
            loadUsers();
            setupTechnicalLevelListener();
        });

        function switchTab(tab) {
            // Hide all sections
            document.getElementById('arxivSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('textSection').style.display = 'none';

            // Reset all tabs
            document.getElementById('arxivTab').style.borderBottomColor = 'transparent';
            document.getElementById('arxivTab').style.color = '#666';
            document.getElementById('uploadTab').style.borderBottomColor = 'transparent';
            document.getElementById('uploadTab').style.color = '#666';
            document.getElementById('textTab').style.borderBottomColor = 'transparent';
            document.getElementById('textTab').style.color = '#666';

            // Show selected tab
            if (tab === 'arxiv') {
                document.getElementById('arxivSection').style.display = 'block';
                document.getElementById('arxivTab').style.borderBottomColor = '#667eea';
                document.getElementById('arxivTab').style.color = '#667eea';
            } else if (tab === 'upload') {
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('uploadTab').style.borderBottomColor = '#667eea';
                document.getElementById('uploadTab').style.color = '#667eea';
            } else if (tab === 'text') {
                document.getElementById('textSection').style.display = 'block';
                document.getElementById('textTab').style.borderBottomColor = '#667eea';
                document.getElementById('textTab').style.color = '#667eea';
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/admin/stats`);
                const data = await response.json();

                document.getElementById('totalSubscribers').textContent = data.total_subscribers;
                document.getElementById('totalPodcasts').textContent = data.total_podcasts;
                document.getElementById('lastSent').textContent = data.last_podcast_date ?
                    new Date(data.last_podcast_date).toLocaleDateString() : 'Never';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadIndividualVoices() {
            try {
                const response = await fetch(`${API_URL}/api/admin/individual-voices`);
                const data = await response.json();

                const hostSelect = document.getElementById('hostVoice');
                const expertSelect = document.getElementById('expertVoice');

                // Clear existing options
                hostSelect.innerHTML = '';
                expertSelect.innerHTML = '';

                // Populate both dropdowns with all available voices
                data.voices.forEach(voice => {
                    // Host dropdown
                    const hostOption = document.createElement('option');
                    hostOption.value = voice.key;
                    hostOption.textContent = `${voice.name} - ${voice.description}`;
                    hostSelect.appendChild(hostOption);

                    // Expert dropdown
                    const expertOption = document.createElement('option');
                    expertOption.value = voice.key;
                    expertOption.textContent = `${voice.name} - ${voice.description}`;
                    expertSelect.appendChild(expertOption);
                });

                // Set default selections (Rachel for host, Adam for expert)
                hostSelect.value = 'rachel';
                expertSelect.value = 'adam';
            } catch (error) {
                console.error('Error loading individual voices:', error);
            }
        }

        function setupTechnicalLevelListener() {
            const levelSelect = document.getElementById('technicalLevel');
            const descriptions = {
                'baby': 'Maximum simplification with everyday analogies - perfect for absolute beginners',
                'highschool': 'Basic concepts without heavy jargon - accessible to most people',
                'undergrad': 'Assumes basic domain knowledge - balanced accessibility and accuracy',
                'graduate': 'Technical but conversational - for professionals in the field',
                'expert': 'Deep technical discussion - assumes expert-level knowledge',
                'nobel': 'Maximum technical sophistication - world-leading expert level'
            };

            levelSelect.addEventListener('change', () => {
                const level = levelSelect.value;
                document.getElementById('technicalLevelDescription').textContent =
                    descriptions[level] || 'Select a technical level';
            });
        }

        let allPersonas = [];

        async function loadPersonas() {
            try {
                const response = await fetch(`${API_URL}/api/admin/personas`);
                const data = await response.json();

                allPersonas = data.personas || [];

                const hostSelect = document.getElementById('hostPersona');
                const expertSelect = document.getElementById('expertPersona');

                // Clear existing options
                hostSelect.innerHTML = '';
                expertSelect.innerHTML = '';

                // Separate hosts and experts
                const hosts = allPersonas.filter(p => p.role === 'Host');
                const experts = allPersonas.filter(p => p.role === 'Expert');

                // Populate host dropdown
                hosts.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona.key;
                    option.textContent = persona.name;
                    option.dataset.personality = persona.personality;
                    option.dataset.voices = JSON.stringify(persona.voice_suggestions);
                    hostSelect.appendChild(option);
                });

                // Populate expert dropdown
                experts.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona.key;
                    option.textContent = persona.name;
                    option.dataset.personality = persona.personality;
                    option.dataset.voices = JSON.stringify(persona.voice_suggestions);
                    expertSelect.appendChild(option);
                });

                // Set defaults
                hostSelect.value = 'curious_journalist';
                expertSelect.value = 'academic_expert';

                // Update descriptions
                updatePersonaDescriptions();

                // Add event listeners
                hostSelect.addEventListener('change', updatePersonaDescriptions);
                expertSelect.addEventListener('change', updatePersonaDescriptions);
            } catch (error) {
                console.error('Error loading personas:', error);
            }
        }

        function updatePersonaDescriptions() {
            const hostSelect = document.getElementById('hostPersona');
            const expertSelect = document.getElementById('expertPersona');

            const hostOption = hostSelect.options[hostSelect.selectedIndex];
            const expertOption = expertSelect.options[expertSelect.selectedIndex];

            if (hostOption) {
                const personality = hostOption.dataset.personality || '';
                const voices = JSON.parse(hostOption.dataset.voices || '[]');
                document.getElementById('hostPersonaDesc').textContent =
                    `${personality} | Suggested voices: ${voices.join(', ')}`;
            }

            if (expertOption) {
                const personality = expertOption.dataset.personality || '';
                const voices = JSON.parse(expertOption.dataset.voices || '[]');
                document.getElementById('expertPersonaDesc').textContent =
                    `${personality} | Suggested voices: ${voices.join(', ')}`;
            }

            // Update voice recommendations in step 3
            updateVoiceRecommendations();
        }

        function updateVoiceRecommendations() {
            const hostSelect = document.getElementById('hostPersona');
            const expertSelect = document.getElementById('expertPersona');

            const hostOption = hostSelect.options[hostSelect.selectedIndex];
            const expertOption = expertSelect.options[expertSelect.selectedIndex];

            if (hostOption && expertOption) {
                const hostVoices = JSON.parse(hostOption.dataset.voices || '[]');
                const expertVoices = JSON.parse(expertOption.dataset.voices || '[]');

                // Set recommended voices if available
                const hostVoiceSelect = document.getElementById('hostVoice');
                const expertVoiceSelect = document.getElementById('expertVoice');

                if (hostVoices.length > 0 && hostVoiceSelect) {
                    hostVoiceSelect.value = hostVoices[0];
                }

                if (expertVoices.length > 0 && expertVoiceSelect) {
                    expertVoiceSelect.value = expertVoices[0];
                }
            }
        }

        async function fetchPaper() {
            const url = document.getElementById('arxivUrl').value.trim();
            const extractFull = document.getElementById('extractFullText').checked;

            if (!url) {
                showMessage('fetchStatus', 'Please enter an arXiv URL', 'error');
                return;
            }

            showSpinner('fetchSpinner');
            hideMessage('fetchStatus');
            document.getElementById('paperPreview').style.display = 'none';

            try {
                const endpoint = extractFull ?
                    `${API_URL}/api/admin/extract-pdf-from-arxiv` :
                    `${API_URL}/api/admin/fetch-paper`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({arxiv_url: url})
                });

                const data = await response.json();

                if (response.ok) {
                    currentPaperId = data.paper_id;
                    hasFullText = extractFull || data.full_text !== undefined;

                    // Display paper preview
                    document.getElementById('paperTitle').textContent = data.title;
                    document.getElementById('paperAuthors').textContent = data.authors.join(', ');
                    document.getElementById('paperAbstract').textContent = data.abstract;
                    document.getElementById('paperId').textContent = data.paper_id;
                    document.getElementById('currentPaperId').textContent = data.paper_id;
                    document.getElementById('paperPreview').style.display = 'block';

                    // Enable transcript generation button
                    document.getElementById('generateTranscriptBtn').disabled = false;
                    document.getElementById('currentPaperId2').textContent = data.paper_id;

                    // Auto-check the full text option if we extracted it
                    if (hasFullText) {
                        document.getElementById('useFullTextForTranscript').checked = true;
                    }

                    showMessage('fetchStatus',
                        extractFull ? 'Paper fetched and full PDF text extracted!' : 'Paper fetched successfully!',
                        'success');
                } else {
                    showMessage('fetchStatus', data.detail || 'Error fetching paper', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('fetchStatus', 'Network error. Please try again.', 'error');
            } finally {
                hideSpinner('fetchSpinner');
            }
        }

        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            const paperUrl = document.getElementById('paperUrl').value.trim();

            if (!paperUrl) {
                showMessage('fetchStatus', 'Please enter the paper URL', 'error');
                return;
            }

            if (!file) {
                showMessage('fetchStatus', 'Please select a PDF file', 'error');
                return;
            }

            showSpinner('fetchSpinner');
            hideMessage('fetchStatus');
            document.getElementById('paperPreview').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('paper_url', paperUrl);

                const response = await fetch(`${API_URL}/api/admin/upload-pdf`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentPaperId = data.paper_id;
                    hasFullText = true;

                    // Display paper preview
                    document.getElementById('paperTitle').textContent = data.title;
                    document.getElementById('paperAuthors').textContent = data.authors.join(', ');
                    document.getElementById('paperAbstract').textContent = data.abstract;
                    document.getElementById('paperId').textContent = data.paper_id;
                    document.getElementById('currentPaperId').textContent = data.paper_id;
                    document.getElementById('paperPreview').style.display = 'block';

                    // Enable transcript generation button and auto-check full text
                    document.getElementById('generateTranscriptBtn').disabled = false;
                    document.getElementById('currentPaperId2').textContent = data.paper_id;
                    document.getElementById('useFullTextForTranscript').checked = true;

                    // Clear form
                    fileInput.value = '';
                    document.getElementById('paperUrl').value = '';

                    showMessage('fetchStatus', 'PDF uploaded and text extracted successfully!', 'success');
                } else {
                    showMessage('fetchStatus', data.detail || 'Error uploading PDF', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('fetchStatus', 'Network error. Please try again.', 'error');
            } finally {
                hideSpinner('fetchSpinner');
            }
        }

        async function generateFromText() {
            const text = document.getElementById('customText').value.trim();
            const title = document.getElementById('textTitle').value.trim() || 'Custom Content';

            if (!text) {
                showMessage('fetchStatus', 'Please paste some text', 'error');
                return;
            }

            if (text.length < 100) {
                showMessage('fetchStatus', 'Please provide at least 100 characters of text', 'error');
                return;
            }

            showSpinner('fetchSpinner');
            hideMessage('fetchStatus');
            document.getElementById('paperPreview').style.display = 'none';
            document.getElementById('transcriptSection').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('text', text);
                formData.append('title', title);

                const response = await fetch(`${API_URL}/api/admin/generate-from-text`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentPaperId = data.paper_id;
                    currentTranscript = data.transcript;

                    // Display "paper" preview
                    document.getElementById('paperTitle').textContent = data.title;
                    document.getElementById('paperAuthors').textContent = 'Custom Text';
                    document.getElementById('paperAbstract').textContent = text.substring(0, 200) + '...';
                    document.getElementById('paperId').textContent = data.paper_id;
                    document.getElementById('currentPaperId').textContent = data.paper_id;
                    document.getElementById('currentPaperId2').textContent = data.paper_id;
                    document.getElementById('paperPreview').style.display = 'block';

                    // Show transcript immediately
                    document.getElementById('transcript').textContent = data.transcript;
                    document.getElementById('transcriptSection').style.display = 'block';

                    // Enable convert button (skip step 2 since we already have transcript)
                    document.getElementById('convertBtn').disabled = false;

                    // Disable transcript generation button (we already have the transcript)
                    document.getElementById('generateTranscriptBtn').disabled = true;

                    // Clear form
                    document.getElementById('customText').value = '';
                    document.getElementById('textTitle').value = '';

                    const length = text.length > 2000 ? '7-10 min' : '5-7 min';
                    showMessage('fetchStatus', `Transcript generated from text! (${length})`, 'success');
                } else {
                    showMessage('fetchStatus', data.detail || 'Error generating from text', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('fetchStatus', 'Network error. Please try again.', 'error');
            } finally {
                hideSpinner('fetchSpinner');
            }
        }

        async function generateTranscript() {
            if (!currentPaperId) return;

            const useFullText = document.getElementById('useFullTextForTranscript').checked;
            const technicalLevel = document.getElementById('technicalLevel').value;
            const customTopics = document.getElementById('customTopics').value.trim();
            const hostPersona = document.getElementById('hostPersona').value;
            const expertPersona = document.getElementById('expertPersona').value;

            showSpinner('transcriptSpinner');
            hideMessage('transcriptStatus');
            document.getElementById('transcriptSection').style.display = 'none';
            document.getElementById('generateTranscriptBtn').disabled = true;

            try {
                const formData = new FormData();
                formData.append('paper_id', currentPaperId);
                formData.append('use_full_text', useFullText);
                formData.append('technical_level', technicalLevel);
                formData.append('host_persona', hostPersona);
                formData.append('expert_persona', expertPersona);
                if (customTopics) {
                    formData.append('custom_topics', customTopics);
                }

                const response = await fetch(`${API_URL}/api/admin/generate-transcript`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentTranscript = data.transcript;

                    // Show transcript
                    document.getElementById('transcript').textContent = data.transcript;
                    document.getElementById('transcriptSection').style.display = 'block';

                    // Enable convert button
                    document.getElementById('convertBtn').disabled = false;

                    const length = useFullText ? '7-10 min' : '5-7 min';
                    const levelText = document.getElementById('technicalLevel').options[document.getElementById('technicalLevel').selectedIndex].text;
                    const hostName = document.getElementById('hostPersona').options[document.getElementById('hostPersona').selectedIndex].text;
                    const expertName = document.getElementById('expertPersona').options[document.getElementById('expertPersona').selectedIndex].text;

                    let successMsg = `Transcript generated! (${length}, ${levelText})`;
                    if (customTopics) {
                        successMsg += ` with custom topics`;
                    }
                    showMessage('transcriptStatus', successMsg, 'success');
                } else {
                    showMessage('transcriptStatus', data.detail || 'Error generating transcript', 'error');
                    document.getElementById('generateTranscriptBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('transcriptStatus', 'Network error. Please try again.', 'error');
                document.getElementById('generateTranscriptBtn').disabled = false;
            } finally {
                hideSpinner('transcriptSpinner');
            }
        }

        function editTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            const currentText = transcriptDiv.textContent;

            // Convert to editable textarea
            const textarea = document.createElement('textarea');
            textarea.style.width = '100%';
            textarea.style.minHeight = '400px';
            textarea.style.padding = '15px';
            textarea.style.fontSize = '14px';
            textarea.style.fontFamily = 'monospace';
            textarea.style.border = '2px solid #667eea';
            textarea.style.borderRadius = '5px';
            textarea.value = currentText;

            transcriptDiv.parentNode.replaceChild(textarea, transcriptDiv);

            // Update button
            const editBtn = event.target;
            editBtn.textContent = 'Save Transcript';
            editBtn.style.background = '#48bb78';
            editBtn.onclick = function() {
                const newDiv = document.createElement('div');
                newDiv.id = 'transcript';
                newDiv.className = 'transcript';
                newDiv.style.display = 'block';
                newDiv.textContent = textarea.value;

                currentTranscript = textarea.value;

                textarea.parentNode.replaceChild(newDiv, textarea);

                editBtn.textContent = 'Edit Transcript';
                editBtn.style.background = '#ed8936';
                editBtn.onclick = editTranscript;

                showMessage('transcriptStatus', 'Transcript updated!', 'success');
            };
        }

        async function convertToAudio() {
            if (!currentPaperId || !currentTranscript) return;

            showSpinner('convertSpinner');
            hideMessage('convertStatus');
            document.getElementById('podcastPreview').style.display = 'none';
            document.getElementById('convertBtn').disabled = true;

            try {
                const hostVoice = document.getElementById('hostVoice').value;
                const expertVoice = document.getElementById('expertVoice').value;

                const formData = new FormData();
                formData.append('paper_id', currentPaperId);
                formData.append('transcript', currentTranscript);
                formData.append('host_voice_key', hostVoice);
                formData.append('expert_voice_key', expertVoice);

                const response = await fetch(`${API_URL}/api/admin/convert-to-audio`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentPodcastId = data.podcast_id;

                    // Setup audio player
                    document.getElementById('audioSource').src = data.audio_url;
                    document.getElementById('audioPlayer').load();
                    document.getElementById('podcastId').textContent = data.podcast_id;
                    document.getElementById('currentPodcastId').textContent = data.podcast_id;
                    document.getElementById('podcastPreview').style.display = 'block';

                    // Enable send buttons
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('sendTestBtn').disabled = false;

                    // Enable send to selected if users are selected
                    if (selectedUsers.size > 0) {
                        document.getElementById('sendToSelectedBtn').disabled = false;
                    }

                    const hostName = document.getElementById('hostVoice').options[document.getElementById('hostVoice').selectedIndex].text.split(' - ')[0];
                    const expertName = document.getElementById('expertVoice').options[document.getElementById('expertVoice').selectedIndex].text.split(' - ')[0];
                    showMessage('convertStatus', `Podcast audio generated successfully! Host: ${hostName}, Expert: ${expertName}`, 'success');
                } else {
                    showMessage('convertStatus', data.detail || 'Error converting to audio', 'error');
                    document.getElementById('convertBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('convertStatus', 'Network error. Please try again.', 'error');
                document.getElementById('convertBtn').disabled = false;
            } finally {
                hideSpinner('convertSpinner');
            }
        }

        async function sendPodcast() {
            if (!currentPodcastId) return;

            if (!confirm('Are you sure you want to send this podcast to all subscribers?')) {
                return;
            }

            showSpinner('sendSpinner');
            hideMessage('sendStatus');
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/admin/send-podcast`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({podcast_id: currentPodcastId})
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('sendStatus',
                        `Podcast sent! ${data.sent} sent, ${data.failed} failed (${data.total_subscribers} total)`,
                        'success');
                    loadStats();
                    loadHistory();
                } else {
                    showMessage('sendStatus', data.detail || 'Error sending podcast', 'error');
                    document.getElementById('sendBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('sendStatus', 'Network error. Please try again.', 'error');
                document.getElementById('sendBtn').disabled = false;
            } finally {
                hideSpinner('sendSpinner');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/admin/podcast-history`);
                const data = await response.json();

                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';

                if (data.podcasts && data.podcasts.length > 0) {
                    data.podcasts.forEach(p => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = new Date(p.sent_at).toLocaleString();
                        row.insertCell(1).textContent = p.paper_title;
                        row.insertCell(2).textContent = p.recipients_count;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No podcasts sent yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function showSpinner(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideSpinner(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showMessage(id, message, type) {
            const el = document.getElementById(id);
            // Support HTML in messages
            if (message.includes('<br>')) {
                el.innerHTML = message;
            } else {
                el.textContent = message;
            }
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }

        function hideMessage(id) {
            document.getElementById(id).style.display = 'none';
        }

        // User Management Functions
        let allUsers = [];
        let selectedUsers = new Set();

        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/api/admin/users`);
                const data = await response.json();

                allUsers = data.users || [];
                document.getElementById('totalUsers').textContent = data.total || 0;

                renderUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersBody').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; color: #e53e3e;">Error loading users</td></tr>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No users found</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = tbody.insertRow();
                const email = user.email || 'N/A';
                const name = user.name || '-';
                const signupDate = user.signup_timestamp ?
                    new Date(user.signup_timestamp * 1000).toLocaleDateString() : 'Unknown';
                const status = user.subscribed !== false ? 'Active' : 'Unsubscribed';

                // Checkbox cell
                const checkboxCell = row.insertCell(0);
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'user-checkbox';
                checkbox.dataset.email = email;
                checkbox.checked = selectedUsers.has(email);
                checkbox.onchange = () => updateSelectedUsers();
                checkboxCell.appendChild(checkbox);

                // Email cell
                row.insertCell(1).textContent = email;

                // Name cell
                row.insertCell(2).textContent = name;

                // Signup date cell
                row.insertCell(3).textContent = signupDate;

                // Status cell
                const statusCell = row.insertCell(4);
                statusCell.textContent = status;
                statusCell.style.color = status === 'Active' ? '#48bb78' : '#f56565';
                statusCell.style.fontWeight = '600';
            });

            updateSelectedCount();
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(user => {
                const email = (user.email || '').toLowerCase();
                const name = (user.name || '').toLowerCase();
                return email.includes(searchTerm) || name.includes(searchTerm);
            });
            renderUsers(filtered);
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            const checkboxes = document.querySelectorAll('.user-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                const email = checkbox.dataset.email;
                if (selectAllCheckbox.checked) {
                    selectedUsers.add(email);
                } else {
                    selectedUsers.delete(email);
                }
            });

            updateSelectedCount();
        }

        function updateSelectedUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            selectedUsers.clear();

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedUsers.add(checkbox.dataset.email);
                }
            });

            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            const visibleCheckboxes = Array.from(checkboxes);
            const allChecked = visibleCheckboxes.length > 0 &&
                visibleCheckboxes.every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;

            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedUsers.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('composeEmailBtn').disabled = count === 0;

            // Enable/disable "Send to Selected Users" button based on selection AND podcast availability
            const sendToSelectedBtn = document.getElementById('sendToSelectedBtn');
            if (sendToSelectedBtn) {
                sendToSelectedBtn.disabled = count === 0 || !currentPodcastId;
            }
        }

        function showEmailComposer() {
            if (selectedUsers.size === 0) {
                alert('Please select at least one user');
                return;
            }

            document.getElementById('recipientCount').textContent = selectedUsers.size;
            document.getElementById('emailComposerCard').style.display = 'block';

            // Scroll to email composer
            document.getElementById('emailComposerCard').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        function hideEmailComposer() {
            document.getElementById('emailComposerCard').style.display = 'none';
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailMessage').value = '';
            hideMessage('emailStatus');
        }

        async function sendManualEmail() {
            const fromName = document.getElementById('emailFromName').value.trim();
            const subject = document.getElementById('emailSubject').value.trim();
            const message = document.getElementById('emailMessage').value.trim();

            if (!subject) {
                showMessage('emailStatus', 'Please enter a subject', 'error');
                return;
            }

            if (!message) {
                showMessage('emailStatus', 'Please enter a message', 'error');
                return;
            }

            if (selectedUsers.size === 0) {
                showMessage('emailStatus', 'No users selected', 'error');
                return;
            }

            const confirmed = confirm(
                `Are you sure you want to send this email to ${selectedUsers.size} users?\n\n` +
                `Subject: ${subject}\n\n` +
                `This action cannot be undone.`
            );

            if (!confirmed) return;

            showSpinner('emailSpinner');
            hideMessage('emailStatus');
            document.getElementById('sendEmailBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/admin/send-manual-email`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        subject: subject,
                        message: message,
                        recipients: Array.from(selectedUsers),
                        from_name: fromName || 'AI Research Podcasts'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('emailStatus',
                        `Email sent successfully! ${data.sent} sent, ${data.failed} failed`,
                        'success');

                    // Clear form and selections after successful send
                    setTimeout(() => {
                        hideEmailComposer();
                        selectedUsers.clear();
                        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
                        document.getElementById('selectAllUsers').checked = false;
                        updateSelectedCount();
                    }, 3000);
                } else {
                    showMessage('emailStatus', data.detail || 'Error sending email', 'error');
                    document.getElementById('sendEmailBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('emailStatus', 'Network error. Please try again.', 'error');
                document.getElementById('sendEmailBtn').disabled = false;
            } finally {
                hideSpinner('emailSpinner');
            }
        }

        // Quick Add User Function
        async function quickAddUser() {
            const email = document.getElementById('quickAddEmail').value.trim();
            const name = document.getElementById('quickAddName').value.trim();

            if (!email) {
                showMessage('quickAddStatus', 'Please enter an email address', 'error');
                return;
            }

            // Basic email validation
            if (!email.includes('@')) {
                showMessage('quickAddStatus', 'Please enter a valid email address', 'error');
                return;
            }

            const btn = document.getElementById('quickAddBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            hideMessage('quickAddStatus');

            try {
                const response = await fetch(`${API_URL}/api/admin/quick-add-user`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, name: name || null})
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('quickAddStatus', `‚úì User added: ${email}`, 'success');
                    document.getElementById('quickAddEmail').value = '';
                    document.getElementById('quickAddName').value = '';

                    // Refresh users list
                    setTimeout(() => {
                        loadUsers();
                        loadStats();
                    }, 1000);
                } else {
                    if (response.status === 409) {
                        showMessage('quickAddStatus', 'Email already exists', 'error');
                    } else {
                        showMessage('quickAddStatus', data.detail || 'Error adding user', 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('quickAddStatus', 'Network error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add User';
            }
        }

        // Bulk Import CSV Function
        async function bulkImportCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('bulkImportStatus', 'Please select a CSV file', 'error');
                return;
            }

            const btn = document.getElementById('bulkImportBtn');
            btn.disabled = true;
            btn.textContent = 'Importing...';
            hideMessage('bulkImportStatus');
            showSpinner('bulkImportSpinner');

            try {
                // Read file as text
                const text = await file.text();

                // Parse emails from CSV (handle both newlines and commas)
                const lines = text.split(/[\n\r]+/);
                const emails = [];

                for (const line of lines) {
                    // Split by comma and trim
                    const parts = line.split(',').map(p => p.trim());

                    for (const part of parts) {
                        // Basic email validation
                        if (part && part.includes('@') && part.includes('.')) {
                            // Clean up email (remove quotes, whitespace, etc.)
                            const cleanEmail = part.replace(/["'\s]/g, '');
                            if (cleanEmail && !emails.includes(cleanEmail)) {
                                emails.push(cleanEmail);
                            }
                        }
                    }
                }

                if (emails.length === 0) {
                    showMessage('bulkImportStatus', 'No valid emails found in file', 'error');
                    hideSpinner('bulkImportSpinner');
                    btn.disabled = false;
                    btn.textContent = 'Import CSV';
                    return;
                }

                // Confirm import
                const confirmed = confirm(
                    `Found ${emails.length} email(s) in file.\n\n` +
                    `First 5: ${emails.slice(0, 5).join(', ')}\n\n` +
                    `Continue with import?`
                );

                if (!confirmed) {
                    hideSpinner('bulkImportSpinner');
                    btn.disabled = false;
                    btn.textContent = 'Import CSV';
                    return;
                }

                // Send to backend
                const response = await fetch(`${API_URL}/api/admin/bulk-import-users`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({emails})
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `‚úì Import complete!\n\n`;
                    message += `Added: ${data.added}\n`;
                    message += `Skipped (already exist): ${data.skipped}\n`;
                    message += `Failed: ${data.failed}\n`;
                    message += `Total processed: ${data.total}`;

                    showMessage('bulkImportStatus', message.replace(/\n/g, '<br>'), 'success');

                    // Clear file input
                    fileInput.value = '';

                    // Refresh users list
                    setTimeout(() => {
                        loadUsers();
                        loadStats();
                    }, 1500);
                } else {
                    showMessage('bulkImportStatus', data.detail || 'Error importing users', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('bulkImportStatus', 'Error processing file. Please try again.', 'error');
            } finally {
                hideSpinner('bulkImportSpinner');
                btn.disabled = false;
                btn.textContent = 'Import CSV';
            }
        }

        // Send Test Email Function
        async function sendTestEmail() {
            if (!currentPodcastId) return;

            const testEmail = prompt('Enter your email address for the test:');
            if (!testEmail || !testEmail.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            if (!confirm(`Send test podcast email to ${testEmail}?`)) {
                return;
            }

            showSpinner('sendSpinner');
            hideMessage('sendStatus');
            document.getElementById('sendTestBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/admin/send-podcast-to-users`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        podcast_id: currentPodcastId,
                        recipient_emails: [testEmail]
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('sendStatus',
                        `‚úì Test email sent to ${testEmail}! Check your inbox.`,
                        'success');
                } else {
                    showMessage('sendStatus', data.detail || 'Error sending test email', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('sendStatus', 'Network error. Please try again.', 'error');
            } finally {
                hideSpinner('sendSpinner');
                document.getElementById('sendTestBtn').disabled = false;
            }
        }

        // Send to Selected Users Function
        async function sendToSelectedUsers() {
            if (!currentPodcastId || selectedUsers.size === 0) return;

            if (!confirm(`Send this podcast to ${selectedUsers.size} selected user(s)?`)) {
                return;
            }

            showSpinner('sendSpinner');
            hideMessage('sendStatus');
            document.getElementById('sendToSelectedBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/admin/send-podcast-to-users`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        podcast_id: currentPodcastId,
                        recipient_emails: Array.from(selectedUsers)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('sendStatus',
                        `‚úì Podcast sent! ${data.sent} sent, ${data.failed} failed to ${selectedUsers.size} selected users`,
                        'success');
                } else {
                    showMessage('sendStatus', data.detail || 'Error sending podcast', 'error');
                    document.getElementById('sendToSelectedBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('sendStatus', 'Network error. Please try again.', 'error');
                document.getElementById('sendToSelectedBtn').disabled = false;
            } finally {
                hideSpinner('sendSpinner');
            }
        }

        // Voice Preview Function
        let currentPreviewAudio = null;

        async function previewVoice(role) {
            const voiceSelect = role === 'host' ?
                document.getElementById('hostVoice') :
                document.getElementById('expertVoice');

            const voiceKey = voiceSelect.value;

            try {
                // Stop any currently playing preview
                if (currentPreviewAudio) {
                    currentPreviewAudio.pause();
                    currentPreviewAudio = null;
                }

                // Fetch and play preview
                const response = await fetch(`${API_URL}/api/admin/voice-preview/${voiceKey}?role=${role}`);

                if (!response.ok) {
                    alert('Error loading voice preview. Please try again.');
                    return;
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                currentPreviewAudio = new Audio(audioUrl);
                currentPreviewAudio.play();

                // Clean up after playing
                currentPreviewAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    currentPreviewAudio = null;
                };
            } catch (error) {
                console.error('Error previewing voice:', error);
                alert('Error playing voice preview. Please try again.');
            }
        }
    </script>
</body>
</html>
