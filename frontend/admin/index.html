<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Research Podcasts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 0;
            margin-bottom: 20px;
        }

        nav .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        nav .logo {
            color: white;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
        }

        nav .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 30px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        nav .nav-links a:hover {
            opacity: 0.8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #333;
        }

        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #48bb78;
        }

        .button-danger {
            background: #f56565;
        }

        .paper-preview {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }

        .paper-preview h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .paper-preview p {
            color: #4a5568;
            margin: 5px 0;
        }

        .audio-player {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .transcript {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            white-space: pre-wrap;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }

        .status-message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status-message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">üéôÔ∏è AI Research Podcasts</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/admin/">Admin</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Admin Dashboard</h1>
            <p>Manage your AI Research Podcasts</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Subscribers</h3>
                <div class="value" id="totalSubscribers">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Podcasts</h3>
                <div class="value" id="totalPodcasts">-</div>
            </div>
            <div class="stat-card">
                <h3>Last Sent</h3>
                <div class="value" style="font-size: 18px;" id="lastSent">-</div>
            </div>
        </div>

        <!-- Fetch Paper Card -->
        <div class="card">
            <h2>1. Add Paper</h2>

            <!-- Tab Navigation -->
            <div style="margin-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                <button onclick="switchTab('arxiv')" id="arxivTab" style="background: none; border: none; border-bottom: 3px solid #667eea; padding: 10px 20px; margin-bottom: -2px; color: #667eea; font-weight: 600;">From arXiv</button>
                <button onclick="switchTab('upload')" id="uploadTab" style="background: none; border: none; border-bottom: 3px solid transparent; padding: 10px 20px; margin-bottom: -2px; color: #666; font-weight: 600;">Upload PDF</button>
            </div>

            <!-- arXiv Tab -->
            <div id="arxivSection">
                <input type="url" id="arxivUrl" placeholder="https://arxiv.org/abs/2401.12345">
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="extractFullText" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span>Extract full PDF text (generates 7-10 min podcast instead of 5-7 min)</span>
                    </label>
                </div>
                <button onclick="fetchPaper()">Fetch Paper</button>
            </div>

            <!-- Upload Tab -->
            <div id="uploadSection" style="display: none;">
                <p style="color: #666; margin-bottom: 15px;">Upload a PDF and we'll automatically extract the text for your podcast.</p>
                <input type="url" id="paperUrl" placeholder="Paper URL (required - e.g., https://arxiv.org/abs/2401.12345)" required style="margin-bottom: 15px;">
                <input type="file" id="pdfFile" accept=".pdf" style="margin-bottom: 15px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                <button onclick="uploadPDF()">Upload PDF</button>
            </div>

            <div id="fetchSpinner" class="spinner"></div>
            <div id="fetchStatus" class="status-message"></div>

            <div id="paperPreview" class="paper-preview">
                <h3 id="paperTitle"></h3>
                <p><strong>Authors:</strong> <span id="paperAuthors"></span></p>
                <p><strong>Abstract:</strong> <span id="paperAbstract"></span></p>
                <p><strong>Paper ID:</strong> <span id="paperId"></span></p>
            </div>
        </div>

        <!-- Generate Transcript Card -->
        <div class="card">
            <h2>2. Generate Transcript</h2>
            <p style="color: #666; margin-bottom: 15px;">Paper ID: <span id="currentPaperId">-</span></p>
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="useFullTextForTranscript" style="margin-right: 10px; width: 20px; height: 20px;">
                    <span>Use full PDF text (7-10 min script instead of 5-7 min from abstract only)</span>
                </label>
            </div>
            <button onclick="generateTranscript()" id="generateTranscriptBtn" disabled>Generate Transcript</button>

            <div id="transcriptSpinner" class="spinner"></div>
            <div id="transcriptStatus" class="status-message"></div>

            <div id="transcriptSection" style="display: none;">
                <h3 style="margin-top: 20px;">üìù Generated Transcript:</h3>
                <div id="transcript" class="transcript" style="display: block;"></div>
                <button onclick="editTranscript()" style="margin-top: 10px; background: #ed8936;">Edit Transcript</button>
            </div>
        </div>

        <!-- Convert to Audio Card -->
        <div class="card">
            <h2>3. Convert to Audio</h2>
            <p style="color: #666; margin-bottom: 15px;">Paper ID: <span id="currentPaperId2">-</span></p>
            <button onclick="convertToAudio()" id="convertBtn" disabled>Convert Transcript to Podcast</button>

            <div id="convertSpinner" class="spinner"></div>
            <div id="convertStatus" class="status-message"></div>

            <div id="podcastPreview" class="audio-player">
                <h3>üéß Podcast Generated!</h3>
                <audio controls id="audioPlayer" style="width: 100%; max-width: 600px; margin: 15px 0;">
                    <source id="audioSource" type="audio/mpeg">
                </audio>
                <p>Podcast ID: <span id="podcastId"></span></p>
            </div>
        </div>

        <!-- Send Email Card -->
        <div class="card">
            <h2>4. Send to Subscribers</h2>
            <p style="color: #666; margin-bottom: 15px;">Current Podcast: <span id="currentPodcastId">-</span></p>
            <button onclick="sendPodcast()" id="sendBtn" class="button-secondary" disabled>Send to All Subscribers</button>

            <div id="sendSpinner" class="spinner"></div>
            <div id="sendStatus" class="status-message"></div>
        </div>

        <!-- History Card -->
        <div class="card">
            <h2>Podcast History</h2>
            <button onclick="loadHistory()" style="margin-bottom: 20px;">Refresh History</button>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Date Sent</th>
                        <th>Paper Title</th>
                        <th>Recipients</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'https://four0k-arr-saas.onrender.com';
        const ADMIN_PASSWORD = 'podcast2025'; // Change this to your desired password
        let currentPaperId = null;
        let currentPodcastId = null;
        let currentTranscript = null;
        let hasFullText = false;

        // Check password on page load
        window.addEventListener('load', () => {
            const savedPassword = sessionStorage.getItem('adminPassword');
            if (savedPassword !== ADMIN_PASSWORD) {
                const password = prompt('Enter admin password:');
                if (password !== ADMIN_PASSWORD) {
                    alert('Incorrect password');
                    window.location.href = '/';
                    return;
                }
                sessionStorage.setItem('adminPassword', password);
            }

            loadStats();
            loadHistory();
        });

        function switchTab(tab) {
            if (tab === 'arxiv') {
                document.getElementById('arxivSection').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('arxivTab').style.borderBottomColor = '#667eea';
                document.getElementById('arxivTab').style.color = '#667eea';
                document.getElementById('uploadTab').style.borderBottomColor = 'transparent';
                document.getElementById('uploadTab').style.color = '#666';
            } else {
                document.getElementById('arxivSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('arxivTab').style.borderBottomColor = 'transparent';
                document.getElementById('arxivTab').style.color = '#666';
                document.getElementById('uploadTab').style.borderBottomColor = '#667eea';
                document.getElementById('uploadTab').style.color = '#667eea';
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/admin/stats`);
                const data = await response.json();

                document.getElementById('totalSubscribers').textContent = data.total_subscribers;
                document.getElementById('totalPodcasts').textContent = data.total_podcasts;
                document.getElementById('lastSent').textContent = data.last_podcast_date ?
                    new Date(data.last_podcast_date).toLocaleDateString() : 'Never';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function fetchPaper() {
            const url = document.getElementById('arxivUrl').value.trim();
            const extractFull = document.getElementById('extractFullText').checked;

            if (!url) {
                showMessage('fetchStatus', 'Please enter an arXiv URL', 'error');
                return;
            }

            showSpinner('fetchSpinner');
            hideMessage('fetchStatus');
            document.getElementById('paperPreview').style.display = 'none';

            try {
                const endpoint = extractFull ?
                    `${API_URL}/api/admin/extract-pdf-from-arxiv` :
                    `${API_URL}/api/admin/fetch-paper`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({arxiv_url: url})
                });

                const data = await response.json();

                if (response.ok) {
                    currentPaperId = data.paper_id;
                    hasFullText = extractFull || data.full_text !== undefined;

                    // Display paper preview
                    document.getElementById('paperTitle').textContent = data.title;
                    document.getElementById('paperAuthors').textContent = data.authors.join(', ');
                    document.getElementById('paperAbstract').textContent = data.abstract;
                    document.getElementById('paperId').textContent = data.paper_id;
                    document.getElementById('currentPaperId').textContent = data.paper_id;
                    document.getElementById('paperPreview').style.display = 'block';

                    // Enable transcript generation button
                    document.getElementById('generateTranscriptBtn').disabled = false;
                    document.getElementById('currentPaperId2').textContent = data.paper_id;

                    // Auto-check the full text option if we extracted it
                    if (hasFullText) {
                        document.getElementById('useFullTextForTranscript').checked = true;
                    }

                    showMessage('fetchStatus',
                        extractFull ? 'Paper fetched and full PDF text extracted!' : 'Paper fetched successfully!',
                        'success');
                } else {
                    showMessage('fetchStatus', data.detail || 'Error fetching paper', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('fetchStatus', 'Network error. Please try again.', 'error');
            } finally {
                hideSpinner('fetchSpinner');
            }
        }

        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            const paperUrl = document.getElementById('paperUrl').value.trim();

            if (!paperUrl) {
                showMessage('fetchStatus', 'Please enter the paper URL', 'error');
                return;
            }

            if (!file) {
                showMessage('fetchStatus', 'Please select a PDF file', 'error');
                return;
            }

            showSpinner('fetchSpinner');
            hideMessage('fetchStatus');
            document.getElementById('paperPreview').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('paper_url', paperUrl);

                const response = await fetch(`${API_URL}/api/admin/upload-pdf`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentPaperId = data.paper_id;
                    hasFullText = true;

                    // Display paper preview
                    document.getElementById('paperTitle').textContent = data.title;
                    document.getElementById('paperAuthors').textContent = data.authors.join(', ');
                    document.getElementById('paperAbstract').textContent = data.abstract;
                    document.getElementById('paperId').textContent = data.paper_id;
                    document.getElementById('currentPaperId').textContent = data.paper_id;
                    document.getElementById('paperPreview').style.display = 'block';

                    // Enable transcript generation button and auto-check full text
                    document.getElementById('generateTranscriptBtn').disabled = false;
                    document.getElementById('currentPaperId2').textContent = data.paper_id;
                    document.getElementById('useFullTextForTranscript').checked = true;

                    // Clear form
                    fileInput.value = '';
                    document.getElementById('paperUrl').value = '';

                    showMessage('fetchStatus', 'PDF uploaded and text extracted successfully!', 'success');
                } else {
                    showMessage('fetchStatus', data.detail || 'Error uploading PDF', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('fetchStatus', 'Network error. Please try again.', 'error');
            } finally {
                hideSpinner('fetchSpinner');
            }
        }

        async function generateTranscript() {
            if (!currentPaperId) return;

            const useFullText = document.getElementById('useFullTextForTranscript').checked;

            showSpinner('transcriptSpinner');
            hideMessage('transcriptStatus');
            document.getElementById('transcriptSection').style.display = 'none';
            document.getElementById('generateTranscriptBtn').disabled = true;

            try {
                const formData = new FormData();
                formData.append('paper_id', currentPaperId);
                formData.append('use_full_text', useFullText);

                const response = await fetch(`${API_URL}/api/admin/generate-transcript`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentTranscript = data.transcript;

                    // Show transcript
                    document.getElementById('transcript').textContent = data.transcript;
                    document.getElementById('transcriptSection').style.display = 'block';

                    // Enable convert button
                    document.getElementById('convertBtn').disabled = false;

                    const length = useFullText ? '7-10 min' : '5-7 min';
                    showMessage('transcriptStatus', `Transcript generated successfully! (${length})`, 'success');
                } else {
                    showMessage('transcriptStatus', data.detail || 'Error generating transcript', 'error');
                    document.getElementById('generateTranscriptBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('transcriptStatus', 'Network error. Please try again.', 'error');
                document.getElementById('generateTranscriptBtn').disabled = false;
            } finally {
                hideSpinner('transcriptSpinner');
            }
        }

        function editTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            const currentText = transcriptDiv.textContent;

            // Convert to editable textarea
            const textarea = document.createElement('textarea');
            textarea.style.width = '100%';
            textarea.style.minHeight = '400px';
            textarea.style.padding = '15px';
            textarea.style.fontSize = '14px';
            textarea.style.fontFamily = 'monospace';
            textarea.style.border = '2px solid #667eea';
            textarea.style.borderRadius = '5px';
            textarea.value = currentText;

            transcriptDiv.parentNode.replaceChild(textarea, transcriptDiv);

            // Update button
            const editBtn = event.target;
            editBtn.textContent = 'Save Transcript';
            editBtn.style.background = '#48bb78';
            editBtn.onclick = function() {
                const newDiv = document.createElement('div');
                newDiv.id = 'transcript';
                newDiv.className = 'transcript';
                newDiv.style.display = 'block';
                newDiv.textContent = textarea.value;

                currentTranscript = textarea.value;

                textarea.parentNode.replaceChild(newDiv, textarea);

                editBtn.textContent = 'Edit Transcript';
                editBtn.style.background = '#ed8936';
                editBtn.onclick = editTranscript;

                showMessage('transcriptStatus', 'Transcript updated!', 'success');
            };
        }

        async function convertToAudio() {
            if (!currentPaperId || !currentTranscript) return;

            showSpinner('convertSpinner');
            hideMessage('convertStatus');
            document.getElementById('podcastPreview').style.display = 'none';
            document.getElementById('convertBtn').disabled = true;

            try {
                const formData = new FormData();
                formData.append('paper_id', currentPaperId);
                formData.append('transcript', currentTranscript);

                const response = await fetch(`${API_URL}/api/admin/convert-to-audio`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentPodcastId = data.podcast_id;

                    // Setup audio player
                    document.getElementById('audioSource').src = data.audio_url;
                    document.getElementById('audioPlayer').load();
                    document.getElementById('podcastId').textContent = data.podcast_id;
                    document.getElementById('currentPodcastId').textContent = data.podcast_id;
                    document.getElementById('podcastPreview').style.display = 'block';

                    // Enable send button
                    document.getElementById('sendBtn').disabled = false;

                    showMessage('convertStatus', 'Podcast audio generated successfully!', 'success');
                } else {
                    showMessage('convertStatus', data.detail || 'Error converting to audio', 'error');
                    document.getElementById('convertBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('convertStatus', 'Network error. Please try again.', 'error');
                document.getElementById('convertBtn').disabled = false;
            } finally {
                hideSpinner('convertSpinner');
            }
        }

        async function sendPodcast() {
            if (!currentPodcastId) return;

            if (!confirm('Are you sure you want to send this podcast to all subscribers?')) {
                return;
            }

            showSpinner('sendSpinner');
            hideMessage('sendStatus');
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/admin/send-podcast`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({podcast_id: currentPodcastId})
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('sendStatus',
                        `Podcast sent! ${data.sent} sent, ${data.failed} failed (${data.total_subscribers} total)`,
                        'success');
                    loadStats();
                    loadHistory();
                } else {
                    showMessage('sendStatus', data.detail || 'Error sending podcast', 'error');
                    document.getElementById('sendBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('sendStatus', 'Network error. Please try again.', 'error');
                document.getElementById('sendBtn').disabled = false;
            } finally {
                hideSpinner('sendSpinner');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/admin/podcast-history`);
                const data = await response.json();

                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';

                if (data.podcasts && data.podcasts.length > 0) {
                    data.podcasts.forEach(p => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = new Date(p.sent_at).toLocaleString();
                        row.insertCell(1).textContent = p.paper_title;
                        row.insertCell(2).textContent = p.recipients_count;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No podcasts sent yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function showSpinner(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideSpinner(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showMessage(id, message, type) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }

        function hideMessage(id) {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>
</html>
